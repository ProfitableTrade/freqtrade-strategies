name: Environment
on:
  workflow_dispatch:
    inputs:
      behaviour:
        description: "Behaviour"
        required: true
        default: "start"
        type: choice
        options:
          - start
          - stop

jobs:
  environment:
    runs-on: ubuntu-latest
    env:
      REMOTE_SERVER: root@${{ secrets.REMOTE_SERVER }}
    steps:
      #------------------------------------------------------------
      # Checkout the repository
      #------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
          submodules: true

      #------------------------------------------------------------
      # Create ssh private key
      #------------------------------------------------------------
      - name: 🔑 Prepare ssh private key 🔑
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./id_rsa
          chmod 600 ./id_rsa

      #------------------------------------------------------------
      # Copy to remote
      #------------------------------------------------------------
      - name: 📝 Copy to remote 📝
        run: |
          echo "Copy to remote $REMOTE_SERVER:/root/"
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" "mkdir -p /root/environment"
          yes | scp -o StrictHostKeyChecking=no -i ./id_rsa -r "./environment" "$REMOTE_SERVER:/root/"

      #------------------------------------------------------------
      # Start docker-compose
      #------------------------------------------------------------
      - name: 🚀 Environment 🚀
        run: |
          echo "Stop environment"
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" "[[ -d /root/environment ]] && [[ -f /root/environment/stop.sh  ]] && cd /root/environment && ./stop.sh" >> $GITHUB_STEP_SUMMARY | cat
          echo "Start environment"
          if [[ ${{ inputs.behaviour }} == "start" ]]; then
            ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" "cd /root/environment && export DOMAIN=${{ secrets.REMOTE_SERVER }} && ./start.sh" >> $GITHUB_STEP_SUMMARY | cat
          fi

name: Backtesting
on:
  workflow_dispatch:
    inputs:
      strategy:
        description: "Strategy, example: Strategy0"
        required: true
        default: Strategy001
      time_frames:
        description: "Timeframes, example: 30m"
        required: true
        default: 30m
      start_date:
        description: "Start date - year month day, example: 20230101"
        required: true
        default: "20230101"
      end_date:
        description: "End date - year month day, example: 20230101"
        required: false
        default: ""
      pair:
        description: "Pair, example: SOL/USDT"
        required: true
        type: choice
        default: SOL/USDT
        options:
          - SOL/USDT
          - BTC/USDT
          - ETH/USDT
          - DOT/USDT
          - ADA/USDT
          - LINK/USDT
          - XRP/USDT
          - LTC/USDT
          - BCH/USDT
          - BNB/USDT
          - EOS/USDT
          - TRX/USDT
          - XLM/USDT
          - ETC/USDT
          - XTZ/USDT
          - NEO/USDT
          - ATOM/USDT
          - IOTA/USDT
          - VET/USDT
          - XMR/USDT
          - DASH/USDT
          - ZEC/USDT
          - QTUM/USDT
          - THETA/USDT
          - FIL/USDT
          - UNI/USDT
          - AAVE/USDT
          - COMP/USDT
          - MKR/USDT
          - SNX/USDT
          - YFI/USDT
          - SUSHI/USDT
          - ZRX/USDT
          - KNC/USDT
          - BAND/USDT
          - REN/USDT
          - BAL/USDT
          - OXT/USDT
          - CRV/USDT
          - TRB/USDT
          - UMA/USDT
          - NMR/USDT
          - ANT/USDT
          - LRC/USDT
          - CVC/USDT
          - KAVA/USDT
          - AR/USDT
          - GRT/USDT
          - STORJ/USDT
          - SNM/USDT
          - CTK/USDT
          - BNT/USDT
          - GNO/USDT
          - REP/USDT
          - MLN/USDT
          - CRV/USDT
          - STORJ/USDT
          - SNM/USDT
          - CTK/USDT
          - BNT/USDT
          - GNO/USDT
          - REP/USDT
          - MLN/USDT
          - CRV/USDT
      exchange:
        description: "Exchange, example: binance"
        required: true
        type: choice
        default: binance
        options:
          - binance

jobs:
  backtesting:
    runs-on: ubuntu-latest
    env:
      REMOTE_SERVER: root@${{ secrets.REMOTE_SERVER }}
    steps:
      #------------------------------------------------------------
      # Checkout the repository
      #------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
          submodules: true
      #------------------------------------------------------------
      # Create ssh private key
      #------------------------------------------------------------
      - name: 🔑 Prepare ssh private key 🔑
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./id_rsa
          chmod 600 ./id_rsa
      #------------------------------------------------------------
      # Copy to remote
      #------------------------------------------------------------
      - name: 📝 Copy to remote 📝
        run: |
          echo "Copy to remote $REMOTE_SERVER:/root/"
          yes | scp -o StrictHostKeyChecking=no -i ./id_rsa -r "./user_data" "$REMOTE_SERVER:/root/${{ github.run_number }}/user_data"
          yes | scp -o StrictHostKeyChecking=no -i ./id_rsa "./docker-compose-backtesting.yml" "$REMOTE_SERVER:/root/${{ github.run_number }}/"
      #------------------------------------------------------------
      # Download data
      #------------------------------------------------------------
      - name: 🗃️ Download data 🗃️
        run: |
          echo Download, strategy: ${{ inputs.strategy }} >> $GITHUB_STEP_SUMMARY | cat
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" <<'EOF' 
          set -e 
          cd /root/${{ github.run_number }}
          docker compose -f docker-compose-backtesting.yml \
            run \
            --rm freqtrade download-data \
            --timeframes ${{ inputs.time_frames }} \
            --timerange ${{ inputs.start_date }}-${{ inputs.end_date }} \
            --config /freqtrade/user_data/${{ inputs.exchange }}.json \
            --pairs ${{ inputs.pair }}
          EOF >> $GITHUB_STEP_SUMMARY | cat
      #------------------------------------------------------------
      # Backtesting
      #------------------------------------------------------------
      - name: 🚀 Backtesting 🚀
        run: |
          echo Backtesting, strategy: ${{ inputs.strategy }} >> $GITHUB_STEP_SUMMARY | cat
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" <<'EOF' 
          set -e 
          cd /root/${{ github.run_number }}
          docker compose -f docker-compose-backtesting.yml \
            run \
            --rm freqtrade backtesting \
            --timeframe ${{ inputs.time_frames }} \
            --timerange ${{ inputs.start_date }}-${{ inputs.end_date }} \
            --strategy ${{ inputs.strategy }} \
            --config /freqtrade/user_data/${{ inputs.exchange }}.json \
            --pairs ${{ inputs.pair }}
          EOF >> $GITHUB_STEP_SUMMARY | cat

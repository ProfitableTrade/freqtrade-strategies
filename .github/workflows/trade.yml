name: Trade
on:
  workflow_dispatch:
    inputs:
      strategy:
        description: "Strategy, example: Strategy0"
        required: true
        default: Strategy00
        type: choice
        options:
          - Strategy00
          - CrossEMAStrategy
          - CustomStoplossWithPSAR
          - HourBasedStrategy
          - Strategy00plus
          - Strategy00plus1
      dry_run:
        description: "Dry run option, fake trades if true"
        required: true
        default: true
        type: boolean
      dry_run_wallet:
        description: "Dry run wallet amount"
        required: false
        default: "3000"
      config:
        description: "Config, example: binance"
        required: true
        type: choice
        default: binance
        options:
          - binance

jobs:
  trade:
    runs-on: ubuntu-latest
    env:
      REMOTE_SERVER: root@${{ secrets.REMOTE_SERVER }}
    steps:
      #------------------------------------------------------------
      # Checkout the repository
      #------------------------------------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
          submodules: true
      #------------------------------------------------------------
      # Install rsync
      #------------------------------------------------------------
      - name: Install rsync
        run: |
          sudo apt-get install -y rsync
      #------------------------------------------------------------
      # Create ssh private key
      #------------------------------------------------------------
      - name: 🔑 Prepare ssh private key 🔑
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ./id_rsa
          chmod 600 ./id_rsa
      #------------------------------------------------------------
      # Copy to remote
      #------------------------------------------------------------
      - name: 📝 Copy to remote 📝
        run: |
          echo "Copy to remote $REMOTE_SERVER:/root/"
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" "mkdir -p /root/backtesting/${{ github.run_number }}"
          rsync -avh -e "ssh -o StrictHostKeyChecking=no -i ./id_rsa" "./backtesting/" "$REMOTE_SERVER:/root/backtesting/${{ github.run_number }}"
     
      #------------------------------------------------------------
      # Trade
      #------------------------------------------------------------
      - name: 💰 Trade ( Dry-run ) 💰
        run: |
          echo Trade, strategy: ${{ inputs.strategy }}, config: ${{ inputs.config }} >> $GITHUB_STEP_SUMMARY | cat
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" <<'EOF' 
          set -e 
          cd /root/backtesting/${{ github.run_number }}
          docker compose -f docker-compose-trade.yml \
            run \
            --rm freqtrade trade \
            --strategy ${{ inputs.strategy }} \
            --config /freqtrade/user_data/${{ inputs.cofig }}.json \
            --dry-run \
            --dry-run-wallet ${{ inputs.dry_run_wallet }} 
          EOF | cat >> $GITHUB_STEP_SUMMARY
        if: ${{ inputs.dry_run }}
      
      - name: 💰 Trade 💰
        run: |
          echo Trade, strategy: ${{ inputs.strategy }}, config: ${{ inputs.config }} >> $GITHUB_STEP_SUMMARY | cat
          ssh -o StrictHostKeyChecking=no -i ./id_rsa "$REMOTE_SERVER" <<'EOF' 
          set -e 
          cd /root/backtesting/${{ github.run_number }}
          docker compose -f docker-compose-trade.yml \
            run \
            --rm freqtrade trade \
            --strategy ${{ inputs.strategy }} \
            --config /freqtrade/user_data/${{ inputs.cofig }}.json
          EOF | cat >> $GITHUB_STEP_SUMMARY
